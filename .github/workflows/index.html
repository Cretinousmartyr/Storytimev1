<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flying Unicorn Adventure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Link to the manifest file for PWA installability -->
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      line-height: 1.6;
    }
    p {
      font-size: 18px;
    }
    button {
      padding: 10px 20px;
      margin: 10px 5px 0 0;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="text"] {
      padding: 10px;
      font-size: 16px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div id="game"></div>

  <script>
    // Global state: tracks player name and which islands have been visited
    const state = {
      playerName: "",
      helpedIslandA: false,
      helpedIslandB: false,
    };

    // Story scenes and branching paths
    const scenes = {
      // Starting scene: get the player's name
      start: {
        id: "start",
        text: "Welcome, adventurer! Please enter your name to begin:",
        input: true,
        next: "intro"
      },
      // The introductory narrative
      intro: {
        id: "intro",
        text: "Once upon a time, there was a brave girl named {playerName}. One day, while wandering through a mystical forest, {playerName} discovered a glowing, flying unicorn! The unicorn beckoned {playerName} to join an incredible adventure. Do you accept the invitation?",
        choices: [
          { text: "Yes, I accept!", next: "chooseIsland" },
          { text: "No, I'm not ready.", next: "decline" }
        ]
      },
      decline: {
        id: "decline",
        text: "{playerName} decided that adventures could wait for another day. But a gentle whisper in the wind reminded her that sometimes magic waits for those who dare to dream. Perhaps next time.",
        choices: [
          { text: "Restart Adventure", next: "start" }
        ]
      },
      // Choose which island to visit
      chooseIsland: {
        id: "chooseIsland",
        text: "{playerName} rides high above the clouds on the unicorn. Before you lie two magical islands floating in the sky. One island is home to a friendly group of Rainbow Rabbits who need help, and the other is inhabited by wise Cloud Cats facing a mysterious challenge. Which island do you visit first?",
        choices: [
          { text: "Visit the Rainbow Rabbits Island", next: "islandA" },
          { text: "Visit the Cloud Cats Island", next: "islandB" }
        ]
      },
      // Rainbow Rabbits Island branch
      islandA: {
        id: "islandA",
        text: "On Rainbow Rabbits Island, {playerName} meets a community of colorful rabbits. Their magical prism that powers their rainbows has dimmed. With your help, they set off on a quest to recover a lost gem that will restore the prism’s brilliance. After overcoming playful puzzles and little challenges, the gem is recovered and the rainbows burst forth in dazzling color. The rabbits cheer, and a wise elder proclaims, 'Thank you, {playerName}! Your courage has brightened our world.'",
        choices: [
          { text: "Return to the Clouds", next: "afterIslandA" }
        ],
        onEnter: function() {
          state.helpedIslandA = true;
        }
      },
      afterIslandA: {
        id: "afterIslandA",
        text: "Floating back on the unicorn, {playerName} reflects on the warm gratitude of the Rainbow Rabbits. But there is still more to discover among the clouds.",
        choices: [
          { text: "Visit the Cloud Cats Island", next: "islandB", condition: function(){ return !state.helpedIslandB; } },
          { text: "Revisit Rainbow Rabbits Island", next: "islandA_repeat", condition: function(){ return state.helpedIslandA; } },
          { text: "Proceed to the Final Celebration", next: "final", condition: function(){ return state.helpedIslandA && state.helpedIslandB; } }
        ]
      },
      islandA_repeat: {
        id: "islandA_repeat",
        text: "Back on Rainbow Rabbits Island, the rabbits greet {playerName} with joyful smiles. 'The rainbows remain radiant, thanks to you!' they exclaim. There's nothing more to do here, so it's time to continue the adventure.",
        choices: [
          { text: "Return to the Clouds", next: "chooseIsland" }
        ]
      },
      // Cloud Cats Island branch
      islandB: {
        id: "islandB",
        text: "Arriving at Cloud Cats Island, {playerName} finds the island cloaked in a mysterious fog. The wise Cloud Cats explain that their enchanted bell—used to summon gentle breezes—has lost its chime. With careful thought and a bit of daring, {playerName} helps the cats locate the hidden chime among the clouds. As the bell rings out, the fog lifts and sunlight bathes the island. A contented cat purrs, 'Our thanks, {playerName}. You’ve restored harmony to our home.'",
        choices: [
          { text: "Return to the Clouds", next: "afterIslandB" }
        ],
        onEnter: function() {
          state.helpedIslandB = true;
        }
      },
      afterIslandB: {
        id: "afterIslandB",
        text: "Riding back on the unicorn, {playerName} smiles at the memory of the Cloud Cats’ thanks. Yet the vast skies still call.",
        choices: [
          { text: "Visit the Rainbow Rabbits Island", next: "islandA", condition: function(){ return !state.helpedIslandA; } },
          { text: "Revisit Cloud Cats Island", next: "islandB_repeat", condition: function(){ return state.helpedIslandB; } },
          { text: "Proceed to the Final Celebration", next: "final", condition: function(){ return state.helpedIslandA && state.helpedIslandB; } }
        ]
      },
      islandB_repeat: {
        id: "islandB_repeat",
        text: "Returning to Cloud Cats Island, {playerName} finds the cats eager to greet you again. 'The winds still sing in gratitude!' they say. With nothing further to do, it's time to move on.",
        choices: [
          { text: "Return to the Clouds", next: "chooseIsland" }
        ]
      },
      // Final ending when both islands have been visited
      final: {
        id: "final",
        text: "With both islands thriving and full of magic, the unicorn carries {playerName} to a grand sky‐festival where the Rainbow Rabbits and Cloud Cats celebrate together. The adventure fills {playerName} with joy and wonder. Finally, the unicorn takes {playerName} back home, leaving behind a world of happiness and endless possibilities.",
        choices: [
          { text: "Restart Adventure", next: "start" }
        ]
      }
    };

    // Replace {playerName} placeholders with the entered name
    function fillPlaceholders(text) {
      return text.replace(/{playerName}/g, state.playerName);
    }

    // Text-to-Speech: speak the given text aloud (if supported)
    function speak(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        // Cancel any previous speech before starting new speech.
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      }
    }

    // Render a scene by its id
    function renderScene(sceneId) {
      const scene = scenes[sceneId];
      const container = document.getElementById("game");
      container.innerHTML = ""; // Clear previous content

      // Run any onEnter logic (for example, setting flags)
      if (scene.onEnter) {
        scene.onEnter();
      }

      // Create and display the scene text (with any name replacements)
      const sceneText = document.createElement("p");
      sceneText.textContent = fillPlaceholders(scene.text);
      container.appendChild(sceneText);

      // Automatically read the text aloud
      speak(sceneText.textContent);

      // If the scene expects an input (like entering the player name)
      if (scene.input) {
        const inputField = document.createElement("input");
        inputField.type = "text";
        inputField.placeholder = "Enter your name";
        container.appendChild(inputField);

        const submitButton = document.createElement("button");
        submitButton.textContent = "Start Adventure";
        submitButton.addEventListener("click", function() {
          const name = inputField.value.trim();
          if (name !== "") {
            state.playerName = name;
            renderScene(scene.next);
          }
        });
        container.appendChild(submitButton);
      } 
      // Otherwise, render choices (buttons)
      else if (scene.choices) {
        scene.choices.forEach(function(choice) {
          // If a condition is set for this choice, check it
          if (choice.condition && !choice.condition()) {
            return;
          }
          const btn = document.createElement("button");
          btn.textContent = choice.text;
          btn.addEventListener("click", function() {
            renderScene(choice.next);
          });
          container.appendChild(btn);
        });
      }
    }

    // Start the game by rendering the "start" scene
    renderScene("start");

    // Register a Service Worker for offline/PWA functionality
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
</body>
</html>
